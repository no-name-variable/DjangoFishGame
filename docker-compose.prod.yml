services:
  db:
    image: postgres:16-alpine
    restart: always
    env_file: .env.prod
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: always

  backend:
    build:
      context: ./backend
      dockerfile: ../Dockerfile.backend
    restart: always
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             python manage.py loaddata fixtures/*.json 2>/dev/null || true;
             python manage.py load_images 2>/dev/null || true;
             python manage.py init_game_time 2>/dev/null || true;
             daphne -b 0.0.0.0 -p 8000 config.asgi:application"
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    env_file: .env.prod
    depends_on:
      - db
      - redis

  celery:
    build:
      context: ./backend
      dockerfile: ../Dockerfile.backend
    restart: always
    command: celery -A config worker -l info
    env_file: .env.prod
    depends_on:
      - db
      - redis

  celery-beat:
    build:
      context: ./backend
      dockerfile: ../Dockerfile.backend
    restart: always
    command: celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    env_file: .env.prod
    depends_on:
      - db
      - redis

  frontend:
    build:
      context: ./frontend
      dockerfile: ../Dockerfile.frontend.prod
    restart: always

  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - static_volume:/var/www/static:ro
      - media_volume:/var/www/media:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
    depends_on:
      - backend
      - frontend

volumes:
  pgdata:
  static_volume:
  media_volume:
  certbot_www:
